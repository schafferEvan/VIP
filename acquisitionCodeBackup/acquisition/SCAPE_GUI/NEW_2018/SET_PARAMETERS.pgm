//This SOLIS pg script sets several acquisition parameters.
//The following parameters are NOT set here currently: Pixel Readout Rate, Electronic Shuttering Mode, Sensitivity/Dynamic Range, Overlap Readout, Spurious Noise Filter, Fill Display Window, image rotation, Rolling Shutter Global Clear and Static Blemish Correction.
//These should be set by loading an initialization file at startup. They can be set through a pgm script, but since do not change for the majority of acquisitions, they are not set here.
//By default this program automatically uses Internal triggering and Kinetic Series scans. Can be changed, is not done here.


cls() //clear the output window -- this window prints script outputs in SOLIS.

/***********Parameters to set****************/

read("C:\Users\Axel-SCAPE\Documents\MATLAB\SCAPE_GUI\NEW_2018\cameraConfig.txt",frameRate$)
read("C:\Users\Axel-SCAPE\Documents\MATLAB\SCAPE_GUI\NEW_2018\cameraConfig.txt",w$)
read("C:\Users\Axel-SCAPE\Documents\MATLAB\SCAPE_GUI\NEW_2018\cameraConfig.txt",h$)
read("C:\Users\Axel-SCAPE\Documents\MATLAB\SCAPE_GUI\NEW_2018\cameraConfig.txt",l$)
read("C:\Users\Axel-SCAPE\Documents\MATLAB\SCAPE_GUI\NEW_2018\cameraConfig.txt",bin$)
read("C:\Users\Axel-SCAPE\Documents\MATLAB\SCAPE_GUI\NEW_2018\cameraConfig.txt",rdur$)
read("C:\Users\Axel-SCAPE\Documents\MATLAB\SCAPE_GUI\NEW_2018\cameraConfig.txt",spooldirectory$)
read("C:\Users\Axel-SCAPE\Documents\MATLAB\SCAPE_GUI\NEW_2018\cameraConfig.txt",spoolstem$)

exposuretime=1/val(frameRate$)
width=val(w$)
height=val(h$)
left= val(l$)
bin=val(bin$)
recordduration=val(rdur$) //seconds
xflip=0
yflip=0
chipHeight = detectory()
chipwidth = detectorx()
/*********Check any errors in setting parameters*******/
//...(1) Fix height issues.
if (height>chipHeight) then
	height=chipHeight
else
	//
endif
if (height<16) then
	height=16 //empirically determined.
else
	//
endif
height=height-mod(height,bin) //height has to be divisible by the bin -- set it to the smaller value automatically.
bottom=(chipHeight/2)+1-(height/2) //vertically center.
top=height+bottom-1 //set top based on vertical center.
bottom=floor(bottom)
top=floor(top)

//...(2) Fix width issues.
if (width>detectorx()) then
	width=detectorx()
else
	//
endif
if (width<(bin*40)) then
	width=bin*40 //empirically determined.
else
	//
endif
if (useSPLASSH==0) then
	width=width-mod(width,bin)
	if ((left+width)>detectorx()) then //make sure left+width is not greater than 0
		left = detectorx()-width+1
	else
		left=left-mod(left,bin)+1
	endif
	//width=(width+left-1-mod(width+left-1,bin))
	right=width+left-1

else
	width=width-mod(width,bin) //height has to be divisible by the bin -- set it to the smaller value automatically.
	left=(chipWidth/2)+1-(width/2) //vertically center.
	right=width+left-1
	left=floor(left)
	right=floor(right)
endif

/*****apply settings to the camera*******/
//below is a liittle hack to figure out what the minimum exposure time is when NOT using overlap mode. Setting it to 0 will set the exposure to be 1e-5 which is too small
//adds a small .00001 s when using overlap mode. can change code to account for this.

SetImage(left,right,bin,bottom,top,bin,xflip,yflip) //set image parameters
//print left
//print right
//print bottom
//print top

if (exposuretime<=0.00003) then
	exposuretime=0.00003
else
	//
endif
SetExposureTime(exposuretime)
SetKineticCycleTime(.00000001)
etreal=GetExposureTime()
//print etreal
kt=GetKineticCycleTime()
//print kt
framerate=1/kt

SetExposureTime(kt)
SetKineticCycleTime(1/framerate)
etreal=GetExposureTime()
kt=GetKineticCycleTime()
framerate=1/kt
//print framerate
//print etreal
//print kt
numimages=floor(framerate*recordduration)+100
//print numimages

kill("C:\Users\Axel-SCAPE\Documents\MATLAB\SCAPE_GUI\NEW_2018\cameraConfig_frameRateUpdate.txt")
write("C:\Users\Axel-SCAPE\Documents\MATLAB\SCAPE_GUI\NEW_2018\cameraConfig_frameRateUpdate.txt",framerate)
// Set to 6 for external start. Set to 7 for external exposure
SetTriggerMode(6)
SetKinetics(etreal,numimages,1/framerate)
SetImage(left,right,bin,bottom,top,bin,xflip,yflip) //set image parameterse
// Set spool file settings
setspool(1) // Turn spooling on
setspoolstorage(0) // 0 for Spool to disk, 1 for spool to ram
setspoolformat(0) // option 0 is an unsigned 16 bit integer
//print spoolstem$
setspoolstem(spoolstem$)
setspoollocation(spooldirectory$)